# Fuploader åç«¯æ•°æ®åº“åŠŸèƒ½å¤±æ•ˆå…¨é¢åˆ†ææŠ¥å‘Š

## é—®é¢˜ç°è±¡

ç”¨æˆ·åé¦ˆï¼šå‰ç«¯ç•Œé¢å¯ä»¥æ­£å¸¸æ˜¾ç¤ºï¼Œä½†æ¶‰åŠæ•°æ®åº“çš„æ“ä½œï¼ˆå¦‚è´¦å·ç®¡ç†ã€è§†é¢‘ç®¡ç†ç­‰ï¼‰éƒ½æ— æ³•ä½¿ç”¨ã€‚

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

ç»è¿‡å…¨é¢ä»£ç å®¡æŸ¥ï¼Œå‘ç°ä»¥ä¸‹å…³é”®é—®é¢˜ï¼š

---

## ä¸€ã€Wails ç»‘å®šæœºåˆ¶é—®é¢˜ï¼ˆæœ€å¯èƒ½åŸå› ï¼‰

### 1.1 ç»‘å®šé…ç½®æ£€æŸ¥

**æ–‡ä»¶**: `main.go`

```go
func main() {
    fmt.Println("Starting Fuploader...")
    
    application := app.NewApp()
    fmt.Println("App created")

    err := wails.Run(&options.App{
        Title:  "Fuploader",
        Width:  1024,
        Height: 768,
        AssetServer: &assetserver.Options{
            Assets: assets,
        },
        BackgroundColour: &options.RGBA{R: 27, G: 38, B: 54, A: 1},
        OnStartup:        application.Startup,
        OnShutdown:       application.Shutdown,
        Bind: []interface{}{
            application,  // âœ… ç»‘å®šäº† App ç»“æ„ä½“
        },
    })
    // ...
}
```

**åˆ†æ**: ç»‘å®šé…ç½®çœ‹èµ·æ¥æ­£ç¡®ï¼Œä½†å­˜åœ¨æ½œåœ¨é—®é¢˜ï¼š

### 1.2 æ–¹æ³•å¯è§æ€§é—®é¢˜

**æ–‡ä»¶**: `internal/app/app.go`

æ‰€æœ‰æ•°æ®åº“æ“ä½œæ–¹æ³•éƒ½æ˜¯**å¤§å†™å¼€å¤´**ï¼ˆå…¬å¼€æ–¹æ³•ï¼‰ï¼Œç¬¦åˆ Wails ç»‘å®šè¦æ±‚ï¼š
- âœ… `GetAccounts()` - å…¬å¼€æ–¹æ³•
- âœ… `AddAccount()` - å…¬å¼€æ–¹æ³•
- âœ… `DeleteAccount()` - å…¬å¼€æ–¹æ³•
- âœ… `UpdateAccount()` - å…¬å¼€æ–¹æ³•
- âœ… `ValidateAccount()` - å…¬å¼€æ–¹æ³•
- âœ… `LoginAccount()` - å…¬å¼€æ–¹æ³•

**ç»“è®º**: æ–¹æ³•å¯è§æ€§æ²¡æœ‰é—®é¢˜ã€‚

---

## äºŒã€æ•°æ®åº“åˆå§‹åŒ–é—®é¢˜

### 2.1 åˆå§‹åŒ–æµç¨‹æ£€æŸ¥

**æ–‡ä»¶**: `internal/app/app.go:31-62`

```go
func (a *App) Startup(ctx context.Context) {
    a.ctx = ctx

    if err := config.Init(); err != nil {
        fmt.Printf("Config init failed: %v\n", err)
        return  // âŒ å¦‚æœé…ç½®åˆå§‹åŒ–å¤±è´¥ï¼Œç›´æ¥è¿”å›
    }

    if err := utils.InitLogger(); err != nil {
        fmt.Printf("Logger init failed: %v\n", err)
        return  // âŒ å¦‚æœæ—¥å¿—åˆå§‹åŒ–å¤±è´¥ï¼Œç›´æ¥è¿”å›
    }

    if err := database.Init(); err != nil {
        fmt.Printf("Database init failed: %v\n", err)
        return  // âŒ å¦‚æœæ•°æ®åº“åˆå§‹åŒ–å¤±è´¥ï¼Œç›´æ¥è¿”å›
    }

    db := database.GetDB()
    a.accountService = service.NewAccountService(db)
    a.fileService = service.NewFileService(db)
    a.uploadService = service.NewUploadService(db)
    a.scheduleService = service.NewScheduleService(db)
    
    // ...
    utils.Info("Application started")  // âœ… è®°å½•å¯åŠ¨æˆåŠŸ
}
```

### 2.2 æ½œåœ¨é—®é¢˜ç‚¹

**é—®é¢˜ 1: åˆå§‹åŒ–å¤±è´¥æ²¡æœ‰é€šçŸ¥å‰ç«¯**

å¦‚æœ `Startup` ä¸­çš„ä»»ä½•åˆå§‹åŒ–å¤±è´¥ï¼Œåº”ç”¨ä¼šé™é»˜å¤±è´¥ï¼Œå‰ç«¯æ— æ³•çŸ¥é“åç«¯æ˜¯å¦å‡†å¤‡å°±ç»ªã€‚

**é—®é¢˜ 2: æ•°æ®åº“è·¯å¾„é—®é¢˜**

**æ–‡ä»¶**: `internal/config/config.go:21-26`

```go
func Init() error {
    exePath, err := os.Executable()
    if err != nil {
        return err
    }
    baseDir := filepath.Dir(exePath)
    // ...
}
```

**åˆ†æ**: 
- åœ¨ Windows ä¸Šï¼Œ`os.Executable()` è¿”å›çš„æ˜¯ exe æ–‡ä»¶çš„è·¯å¾„
- å¦‚æœ exe è¢«ç§»åŠ¨æˆ–å¤åˆ¶åˆ°å…¶ä»–ä½ç½®ï¼Œæ•°æ®åº“æ–‡ä»¶è·¯å¾„ä¼šæ”¹å˜
- è¿™å¯èƒ½å¯¼è‡´æ•°æ®åº“æ–‡ä»¶"ä¸¢å¤±"æˆ–é‡æ–°åˆ›å»ºç©ºæ•°æ®åº“

**é—®é¢˜ 3: æ•°æ®åº“ç›®å½•æƒé™**

```go
dirs := []string{
    Config.DbPath,        // å®é™…ä¸Šæ˜¯æ–‡ä»¶è·¯å¾„ï¼Œä¸æ˜¯ç›®å½•
    Config.CookiePath,
    Config.VideoPath,
    Config.LogPath,
    Config.ThumbnailPath,
}
for _, dir := range dirs {
    if err := os.MkdirAll(dir, 0755); err != nil {
        return err
    }
}
```

**ä¸¥é‡é—®é¢˜**: `Config.DbPath` æ˜¯æ•°æ®åº“**æ–‡ä»¶**è·¯å¾„ï¼Œä¸æ˜¯ç›®å½•è·¯å¾„ï¼

**æ–‡ä»¶**: `internal/config/constants.go` (éœ€è¦æ£€æŸ¥)

```go
// å¯èƒ½çš„é…ç½®
const DefaultDbPath = "data/app.db"  // è¿™æ˜¯æ–‡ä»¶è·¯å¾„
```

è¿™ä¼šå¯¼è‡´ `os.MkdirAll` å°è¯•åˆ›å»ºä¸€ä¸ªåä¸º `app.db` çš„ç›®å½•ï¼Œè€Œä¸æ˜¯åœ¨ `data` ç›®å½•ä¸‹åˆ›å»ºæ•°æ®åº“æ–‡ä»¶ï¼

---

## ä¸‰ã€å‰ç«¯ç±»å‹ä¸åŒ¹é…é—®é¢˜

### 3.1 ç±»å‹å®šä¹‰å¯¹æ¯”

**åç«¯æ¨¡å‹** (`internal/database/models.go`):
```go
type Account struct {
    ID         int    `json:"id" gorm:"primaryKey"`
    Platform   string `json:"platform" gorm:"index;not null"`
    Name       string `json:"name" gorm:"not null"`
    Username   string `json:"username"`
    Avatar     string `json:"avatar"`
    CookiePath string `json:"cookiePath"`
    Status     int    `json:"status" gorm:"default:0"`
    CreatedAt  string `json:"createdAt"`
    UpdatedAt  string `json:"updatedAt"`
}
```

**å‰ç«¯ Wails ç”Ÿæˆæ¨¡å‹** (`frontend/wailsjs/go/models.ts`):
```typescript
export class Account {
    id: number;
    platform: string;
    name: string;
    username: string;
    avatar: string;
    cookiePath: string;
    status: number;
    createdAt: string;
    updatedAt: string;
    // ...
}
```

**å‰ç«¯ä¸šåŠ¡ç±»å‹** (`frontend/src/types/account.ts`):
```typescript
export interface Account {
  id: number
  platform: PlatformType  // âŒ è¿™é‡Œæ˜¯è”åˆç±»å‹ 'douyin' | 'tencent' | ...
  name: string
  username?: string        // âŒ å¯é€‰å­—æ®µ
  avatar?: string          // âŒ å¯é€‰å­—æ®µ
  cookiePath?: string      // âŒ å¯é€‰å­—æ®µ
  status: AccountStatus   // âŒ è¿™é‡Œæ˜¯ 0 | 1 | 2
  createdAt: string
  updatedAt: string
}
```

### 3.2 ç±»å‹ä¸åŒ¹é…é—®é¢˜

| å­—æ®µ | åç«¯ç±»å‹ | Wailsç”Ÿæˆç±»å‹ | å‰ç«¯ä¸šåŠ¡ç±»å‹ | é—®é¢˜ |
|------|---------|--------------|-------------|------|
| `platform` | `string` | `string` | `PlatformType` | å‰ç«¯é™åˆ¶æ›´ä¸¥æ ¼ |
| `username` | `string` | `string` | `string \| undefined` | å¯é€‰æ€§ä¸ä¸€è‡´ |
| `avatar` | `string` | `string` | `string \| undefined` | å¯é€‰æ€§ä¸ä¸€è‡´ |
| `cookiePath` | `string` | `string` | `string \| undefined` | å¯é€‰æ€§ä¸ä¸€è‡´ |
| `status` | `int` | `number` | `0 \| 1 \| 2` | å‰ç«¯é™åˆ¶æ›´ä¸¥æ ¼ |

**å½±å“**: è™½ç„¶è¿™äº›ç±»å‹å·®å¼‚ä¸ä¼šå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯ï¼Œä½†å¯èƒ½å¯¼è‡´ TypeScript ç¼–è¯‘è­¦å‘Šæˆ–ç±»å‹æ£€æŸ¥å¤±è´¥ã€‚

---

## å››ã€é”™è¯¯å¤„ç†é—®é¢˜

### 4.1 åç«¯é”™è¯¯å¤„ç†

**æ–‡ä»¶**: `internal/app/app.go:34-47`

```go
if err := config.Init(); err != nil {
    fmt.Printf("Config init failed: %v\n", err)
    return  // âŒ é”™è¯¯åªæ‰“å°åˆ°æ§åˆ¶å°ï¼Œå‰ç«¯ä¸çŸ¥é“
}

if err := utils.InitLogger(); err != nil {
    fmt.Printf("Logger init failed: %v\n", err)
    return  // âŒ é”™è¯¯åªæ‰“å°åˆ°æ§åˆ¶å°ï¼Œå‰ç«¯ä¸çŸ¥é“
}

if err := database.Init(); err != nil {
    fmt.Printf("Database init failed: %v\n", err)
    return  // âŒ é”™è¯¯åªæ‰“å°åˆ°æ§åˆ¶å°ï¼Œå‰ç«¯ä¸çŸ¥é“
}
```

**é—®é¢˜**: æ‰€æœ‰åˆå§‹åŒ–é”™è¯¯éƒ½åªæ‰“å°åˆ°æ§åˆ¶å°ï¼Œæ²¡æœ‰é€šçŸ¥å‰ç«¯ï¼Œå¯¼è‡´å‰ç«¯æ— æ³•æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ã€‚

### 4.2 å‰ç«¯é”™è¯¯å¤„ç†

**æ–‡ä»¶**: `frontend/src/views/Accounts.vue:38-44`

```typescript
catch (error: any) {
  const errorMsg = error?.message || error?.toString() || 'æ·»åŠ è´¦å·å¤±è´¥'
  console.error('æ·»åŠ è´¦å·å¤±è´¥:', error)
  ElMessage.error(`æ·»åŠ è´¦å·å¤±è´¥: ${errorMsg}`)
}
```

**åˆ†æ**: å‰ç«¯é”™è¯¯å¤„ç†å·²ç»æ”¹è¿›ï¼Œå¯ä»¥æ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯ã€‚

---

## äº”ã€æ•°æ®åº“æ“ä½œé—®é¢˜

### 5.1 æœåŠ¡å±‚å®ç°æ£€æŸ¥

**æ–‡ä»¶**: `internal/service/account.go:23-30`

```go
func (s *AccountService) GetAccounts(ctx context.Context) ([]database.Account, error) {
    var accounts []database.Account
    result := s.db.Find(&accounts)  // âœ… ä½¿ç”¨ s.db
    if result.Error != nil {
        return nil, fmt.Errorf("query accounts failed: %w", result.Error)
    }
    return accounts, nil
}
```

**åˆ†æ**: æœåŠ¡å±‚æ­£ç¡®ä½¿ç”¨äº†æ³¨å…¥çš„ `s.db`ï¼Œè€Œä¸æ˜¯å…¨å±€å˜é‡ã€‚

### 5.2 äº‹åŠ¡å¤„ç†

**æ–‡ä»¶**: `internal/service/account.go:44-67`

```go
// ä½¿ç”¨äº‹åŠ¡ç¡®ä¿åŸå­æ€§
err := s.db.Transaction(func(tx *gorm.DB) error {
    // åˆ›å»ºè´¦å·
    if err := tx.Create(account).Error; err != nil {
        return fmt.Errorf("create account failed: %w", err)
    }

    // è®¾ç½® Cookie è·¯å¾„
    account.CookiePath = filepath.Join(config.Config.CookiePath, fmt.Sprintf("%s_%d.json", platform, account.ID))

    // æ›´æ–° Cookie è·¯å¾„
    if err := tx.Model(account).Update("cookie_path", account.CookiePath).Error; err != nil {
        return fmt.Errorf("update cookie path failed: %w", err)
    }

    return nil
})
```

**åˆ†æ**: ä½¿ç”¨äº†äº‹åŠ¡å¤„ç†ï¼Œé€»è¾‘æ­£ç¡®ã€‚

---

## å…­ã€æœ€å¯èƒ½çš„æ ¹æœ¬åŸå› 

### 6.1 æ•°æ®åº“è·¯å¾„é—®é¢˜ï¼ˆé«˜æ¦‚ç‡ï¼‰

**é—®é¢˜**: `config.go` ä¸­çš„ç›®å½•åˆ›å»ºé€»è¾‘æœ‰è¯¯

```go
// å½“å‰ä»£ç 
Config = &AppConfig{
    DbPath:            filepath.Join(baseDir, DefaultDbPath),  // å¦‚: ./data/app.db
    // ...
}

dirs := []string{
    Config.DbPath,  // âŒ è¿™æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œä¸æ˜¯ç›®å½•è·¯å¾„ï¼
    // ...
}
for _, dir := range dirs {
    if err := os.MkdirAll(dir, 0755); err != nil {  // âŒ ä¼šå°è¯•åˆ›å»º app.db ç›®å½•
        return err
    }
}
```

**åæœ**:
1. `os.MkdirAll("./data/app.db", 0755)` ä¼šåˆ›å»ºä¸€ä¸ªåä¸º `app.db` çš„**ç›®å½•**
2. ç„¶åæ•°æ®åº“å°è¯•æ‰“å¼€ `./data/app.db` ä½œä¸º**æ–‡ä»¶**
3. ç”±äº `app.db` å·²ç»æ˜¯ä¸€ä¸ªç›®å½•ï¼Œæ•°æ®åº“æ‰“å¼€ä¼šå¤±è´¥ï¼

### 6.2 éªŒè¯æ–¹æ³•

æ£€æŸ¥ `build/bin/` ç›®å½•ä¸‹æ˜¯å¦æœ‰ï¼š
- `data/app.db` ç›®å½•ï¼ˆé”™è¯¯ï¼‰
- `data/` ç›®å½•ä¸‹çš„ `app.db` æ–‡ä»¶ï¼ˆæ­£ç¡®ï¼‰

---

## ä¸ƒã€ä¿®å¤å»ºè®®

### 7.1 ä¿®å¤æ•°æ®åº“è·¯å¾„é—®é¢˜ï¼ˆç´§æ€¥ï¼‰

**æ–‡ä»¶**: `internal/config/config.go`

```go
func Init() error {
    exePath, err := os.Executable()
    if err != nil {
        return err
    }
    baseDir := filepath.Dir(exePath)

    // å®šä¹‰æ•°æ®ç›®å½•
    dataDir := filepath.Join(baseDir, "data")
    
    Config = &AppConfig{
        DbPath:            filepath.Join(dataDir, "app.db"),  // æ•°æ®åº“æ–‡ä»¶è·¯å¾„
        CookiePath:        filepath.Join(dataDir, "cookies"),
        VideoPath:         filepath.Join(dataDir, "videos"),
        LogPath:           filepath.Join(dataDir, "logs"),
        ThumbnailPath:     filepath.Join(dataDir, "thumbnails"),
        UploadConcurrency: UploadConcurrency,
        DefaultTimeout:    DefaultTimeout,
    }

    // åˆ›å»ºç›®å½•ï¼ˆåªåˆ›å»ºç›®å½•ï¼Œä¸åˆ›å»ºæ•°æ®åº“æ–‡ä»¶è·¯å¾„ï¼‰
    dirs := []string{
        dataDir,                // âœ… æ•°æ®æ ¹ç›®å½•
        Config.CookiePath,      // âœ… cookies ç›®å½•
        Config.VideoPath,       // âœ… videos ç›®å½•
        Config.LogPath,         // âœ… logs ç›®å½•
        Config.ThumbnailPath,   // âœ… thumbnails ç›®å½•
    }
    for _, dir := range dirs {
        if err := os.MkdirAll(dir, 0755); err != nil {
            return fmt.Errorf("create directory %s failed: %w", dir, err)
        }
    }

    return nil
}
```

### 7.2 æ·»åŠ åˆå§‹åŒ–çŠ¶æ€æ£€æŸ¥

**æ–‡ä»¶**: `internal/app/app.go`

```go
type App struct {
    ctx             context.Context
    accountService  *service.AccountService
    fileService     *service.FileService
    uploadService   *service.UploadService
    scheduleService *service.ScheduleService
    scheduler       *scheduler.Scheduler
    initialized     bool   // æ·»åŠ åˆå§‹åŒ–çŠ¶æ€æ ‡å¿—
    initError       string // æ·»åŠ åˆå§‹åŒ–é”™è¯¯ä¿¡æ¯
}

func (a *App) Startup(ctx context.Context) {
    a.ctx = ctx

    if err := config.Init(); err != nil {
        a.initError = fmt.Sprintf("Config init failed: %v", err)
        fmt.Println(a.initError)
        return
    }

    if err := utils.InitLogger(); err != nil {
        a.initError = fmt.Sprintf("Logger init failed: %v", err)
        fmt.Println(a.initError)
        return
    }

    if err := database.Init(); err != nil {
        a.initError = fmt.Sprintf("Database init failed: %v", err)
        fmt.Println(a.initError)
        return
    }

    // ... æœåŠ¡åˆå§‹åŒ– ...

    a.initialized = true
    utils.Info("Application started")
}

// æ·»åŠ å¥åº·æ£€æŸ¥æ–¹æ³•
func (a *App) GetAppStatus() (map[string]interface{}, error) {
    return map[string]interface{}{
        "initialized": a.initialized,
        "error":       a.initError,
    }, nil
}
```

### 7.3 å‰ç«¯æ·»åŠ åˆå§‹åŒ–æ£€æŸ¥

**æ–‡ä»¶**: `frontend/src/App.vue` æˆ– `frontend/src/views/Dashboard.vue`

```typescript
import { GetAppStatus } from '../wailsjs/go/app/App'

onMounted(async () => {
  try {
    const status = await GetAppStatus()
    if (!status.initialized) {
      ElMessage.error(`åº”ç”¨åˆå§‹åŒ–å¤±è´¥: ${status.error}`)
      return
    }
    // ç»§ç»­åŠ è½½æ•°æ®
    await accountStore.fetchAccounts()
  } catch (error) {
    ElMessage.error('æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡')
  }
})
```

---

## å…«ã€éªŒè¯æ­¥éª¤

1. **æ£€æŸ¥æ•°æ®åº“ç›®å½•ç»“æ„**:
   ```powershell
   Get-ChildItem build/bin/data -Recurse
   ```

2. **æ£€æŸ¥æ—¥å¿—æ–‡ä»¶**:
   ```powershell
   Get-Content build/bin/data/logs/app_*.log
   ```

3. **æµ‹è¯•æ•°æ®åº“è¿æ¥**:
   - è¿è¡Œ exe æ–‡ä»¶
   - æ£€æŸ¥æ§åˆ¶å°è¾“å‡º
   - æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯

4. **é‡æ–°æ„å»ºå¹¶æµ‹è¯•**:
   ```bash
   wails build -platform windows/amd64 -clean
   ```

---

## ä¹ã€ç»“è®º

**æœ€å¯èƒ½çš„åŸå› **: æ•°æ®åº“è·¯å¾„é…ç½®é”™è¯¯å¯¼è‡´ `os.MkdirAll` åˆ›å»ºäº†ä¸æ•°æ®åº“æ–‡ä»¶åŒåçš„ç›®å½•ï¼Œå¯¼è‡´æ•°æ®åº“æ— æ³•æ‰“å¼€ã€‚

**æ¬¡è¦åŸå› **: 
1. åˆå§‹åŒ–é”™è¯¯æ²¡æœ‰é€šçŸ¥å‰ç«¯
2. ç±»å‹å®šä¹‰å­˜åœ¨å·®å¼‚ï¼ˆä½†ä¸ä¼šå¯¼è‡´åŠŸèƒ½å¤±æ•ˆï¼‰

**å»ºè®®ä¼˜å…ˆä¿®å¤**: 
1. âœ… ä¿®å¤ `config.go` ä¸­çš„ç›®å½•åˆ›å»ºé€»è¾‘
2. âœ… æ·»åŠ åˆå§‹åŒ–çŠ¶æ€æ£€æŸ¥
3. âœ… å‰ç«¯æ·»åŠ é”™è¯¯å¤„ç†
