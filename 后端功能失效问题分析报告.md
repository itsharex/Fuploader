# Fuploader 后端功能失效问题分析报告

## 问题概述

用户反馈编译后的 exe 文件"后端作用没有了"，经过代码审查，发现以下关键问题：

---

## 🔴 核心问题：数据库和服务初始化时传入 nil

### 问题位置

**文件**: `internal/app/app.go`  
**函数**: `Startup()`  
**行号**: 49-52

```go
a.accountService = service.NewAccountService(nil)  // ❌ 传入 nil
a.fileService = service.NewFileService(nil)        // ❌ 传入 nil
a.uploadService = service.NewUploadService(nil)    // ❌ 传入 nil
a.scheduleService = service.NewScheduleService(nil) // ❌ 传入 nil
```

### 问题分析

虽然代码中使用了全局变量 `database.DB`，但服务层结构体中保留了 `db` 字段：

```go
// internal/service/account.go
type AccountService struct {
    db *gorm.DB  // 这个字段被传入 nil
}
```

这导致以下潜在问题：
1. **代码不一致性**: 服务层同时使用了 `s.db` 和 `database.DB` 两种方式访问数据库
2. **单测困难**: 无法注入 mock 数据库进行单元测试
3. **潜在空指针风险**: 如果某处代码误用了 `s.db` 而不是 `database.DB`，会导致 panic

---

## 🟡 次要问题 1：Cookie 路径生成错误

### 问题位置

**文件**: `internal/config/config.go`  
**函数**: `GetCookiePath()`  
**行号**: 57-59

```go
func GetCookiePath(platform string, accountID uint) string {
    return filepath.Join(Config.CookiePath, platform+"_"+string(rune(accountID))+".json")
    // ❌ 错误的类型转换: string(rune(accountID))
}
```

### 问题分析

`string(rune(accountID))` 会将数字转换为对应的 Unicode 字符，而不是字符串表示：
- `accountID = 1` → 结果是 `"1"` (正确)
- `accountID = 65` → 结果是 `"A"` (错误!)
- `accountID = 97` → 结果是 `"a"` (错误!)

**正确写法**:
```go
func GetCookiePath(platform string, accountID uint) string {
    return filepath.Join(Config.CookiePath, fmt.Sprintf("%s_%d.json", platform, accountID))
}
```

---

## 🟡 次要问题 2：Playwright 依赖未打包

### 问题分析

应用使用了 `playwright-go` 进行浏览器自动化，但：

1. **Playwright 浏览器未安装**: 编译后的 exe 不会自动包含 Playwright 浏览器
2. **运行时依赖**: 需要在目标机器上运行 `playwright install` 命令安装浏览器
3. **首次运行失败**: 如果目标机器没有安装 Chrome/Edge，上传功能会失败

### 影响

- 账号登录功能依赖 Playwright
- 视频上传功能依赖 Playwright
- 账号验证功能依赖 Playwright

---

## 🟡 次要问题 3：数据库路径问题

### 问题位置

**文件**: `internal/config/config.go`  
**函数**: `Init()`  
**行号**: 21-25

```go
exePath, err := os.Executable()
if err != nil {
    return err
}
baseDir := filepath.Dir(exePath)
```

### 问题分析

在 Windows 上，当 exe 被移动或复制到其他位置时：
1. 数据库文件路径会改变
2. 原有的数据会"丢失"（因为数据库文件在旧位置）
3. 需要重新初始化所有配置和数据

---

## 🟡 次要问题 4：前端错误处理不完善

### 问题位置

**文件**: `frontend/src/views/Accounts.vue` 等

### 问题分析

前端代码中错误处理过于简单：

```typescript
// 示例：Accounts.vue
async function handleAddAccount() {
  // ...
  try {
    await accountStore.addAccount(newAccount.value.platform, newAccount.value.name.trim())
    ElMessage.success('账号添加成功')
    // ...
  } catch (error) {
    ElMessage.error('添加账号失败')  // ❌ 没有显示具体错误信息
  }
}
```

用户无法得知后端返回的具体错误原因。

---

## 📋 修复建议

### 1. 修复数据库初始化（高优先级）

```go
// internal/app/app.go
func (a *App) Startup(ctx context.Context) {
    a.ctx = ctx

    if err := config.Init(); err != nil {
        fmt.Printf("Config init failed: %v\n", err)
        return
    }

    if err := utils.InitLogger(); err != nil {
        fmt.Printf("Logger init failed: %v\n", err)
        return
    }

    if err := database.Init(); err != nil {
        fmt.Printf("Database init failed: %v\n", err)
        return
    }

    // ✅ 修复：传入实际的数据库实例
    db := database.GetDB()
    a.accountService = service.NewAccountService(db)
    a.fileService = service.NewFileService(db)
    a.uploadService = service.NewUploadService(db)
    a.scheduleService = service.NewScheduleService(db)
    
    // ...
}
```

### 2. 修复 Cookie 路径生成（高优先级）

```go
// internal/config/config.go
import "fmt"

func GetCookiePath(platform string, accountID uint) string {
    return filepath.Join(Config.CookiePath, fmt.Sprintf("%s_%d.json", platform, accountID))
}
```

### 3. 添加 Playwright 安装检查（中优先级）

在应用启动时检查 Playwright 浏览器是否已安装：

```go
func checkPlaywrightInstallation() error {
    // 检查 playwright 浏览器是否已安装
    // 如未安装，提示用户或自动安装
}
```

### 4. 改进错误处理（中优先级）

前端显示详细的错误信息：

```typescript
catch (error: any) {
    const message = error?.message || '添加账号失败'
    ElMessage.error(message)
}
```

---

## 🧪 验证步骤

1. **重新编译**:
   ```bash
   wails build -platform windows/amd64
   ```

2. **测试数据库功能**:
   - 添加账号
   - 查看账号列表
   - 删除账号

3. **测试上传功能**:
   - 添加视频
   - 创建上传任务
   - 验证 Playwright 是否能正常启动浏览器

4. **检查 Cookie 文件**:
   - 确认 Cookie 文件命名正确（如 `douyin_123.json` 而不是 `douyin_{.json`）

---

## 📁 相关文件清单

| 文件路径 | 问题 | 优先级 |
|---------|------|--------|
| `internal/app/app.go:49-52` | 服务初始化传入 nil | 🔴 高 |
| `internal/config/config.go:57-59` | Cookie 路径生成错误 | 🔴 高 |
| `internal/service/*.go` | 混用 s.db 和 database.DB | 🟡 中 |
| `frontend/src/views/*.vue` | 错误处理不完善 | 🟡 中 |
| Playwright 依赖 | 浏览器未打包 | 🟡 中 |

---

## 结论

后端功能"失效"的主要原因可能是：

1. **Cookie 路径生成错误**导致登录/验证功能无法正常工作（ID > 9 的账号会出现问题）
2. **Playwright 浏览器未安装**导致上传和登录功能完全无法使用
3. **数据库初始化代码不规范**虽然当前可能工作，但存在潜在风险

建议优先修复 Cookie 路径生成问题和添加 Playwright 安装检查。
